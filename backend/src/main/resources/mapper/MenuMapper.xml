<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esfile.mapper.MenuMapper">

    <!-- 结果映射 -->
    <resultMap id="MenuResultMap" type="com.esfile.entity.mybatis.Menu">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="path" property="path"/>
        <result column="component" property="component"/>
        <result column="icon" property="icon"/>
        <result column="parent_id" property="parentId"/>
        <result column="sort" property="sort"/>
        <result column="status" property="status"/>
        <result column="type" property="type"/>
        <result column="permission" property="permission"/>
        <result column="is_frame" property="isFrame"/>
        <result column="is_cache" property="isCache"/>
        <result column="visible" property="visible"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, name, path, component, icon, parent_id, sort, status, type, permission,
        is_frame, is_cache, visible, create_time, update_time, create_by, update_by, remark
    </sql>

    <!-- 查询条件 -->
    <sql id="Base_Where_Clause">
        WHERE deleted = 0
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="type != null">
            AND type = #{type}
        </if>
        <if test="permission != null and permission != ''">
            AND permission = #{permission}
        </if>
    </sql>

    <!-- 查询所有菜单 -->
    <select id="selectAll" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE deleted = 0
        ORDER BY sort ASC, create_time ASC
    </select>

    <!-- 根据ID查询菜单 -->
    <select id="selectById" parameterType="long" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE id = #{id} AND deleted = 0
    </select>

    <!-- 插入菜单 -->
    <insert id="insert" parameterType="com.esfile.entity.mybatis.Menu" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_menu (
            name, path, component, icon, parent_id, sort, status, type, permission,
            is_frame, is_cache, visible, create_by, update_by, remark
        ) VALUES (
            #{name}, #{path}, #{component}, #{icon}, #{parentId}, #{sort}, #{status}, #{type}, #{permission},
            #{isFrame}, #{isCache}, #{visible}, #{createBy}, #{updateBy}, #{remark}
        )
    </insert>

    <!-- 更新菜单 -->
    <update id="updateById" parameterType="com.esfile.entity.mybatis.Menu">
        UPDATE sys_menu
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="path != null">path = #{path},</if>
            <if test="component != null">component = #{component},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="sort != null">sort = #{sort},</if>
            <if test="status != null">status = #{status},</if>
            <if test="type != null">type = #{type},</if>
            <if test="permission != null">permission = #{permission},</if>
            <if test="isFrame != null">is_frame = #{isFrame},</if>
            <if test="isCache != null">is_cache = #{isCache},</if>
            <if test="visible != null">visible = #{visible},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 根据ID删除菜单 -->
    <update id="deleteById" parameterType="long">
        UPDATE sys_menu
        SET deleted = 1, update_time = CURRENT_TIMESTAMP
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 根据父ID查询子菜单 -->
    <select id="selectByParentId" parameterType="long" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE parent_id = #{parentId} AND deleted = 0
        ORDER BY sort ASC, create_time ASC
    </select>

    <!-- 根据角色ID查询菜单 -->
    <select id="selectByRoleId" parameterType="long" resultMap="MenuResultMap">
        SELECT DISTINCT m.<include refid="Base_Column_List"/>
        FROM sys_menu m
        INNER JOIN sys_role_permission rp ON m.permission = rp.permission_id
        WHERE rp.role_id = #{roleId} 
        AND m.deleted = 0 
        AND rp.deleted = 0
        ORDER BY m.sort ASC, m.create_time ASC
    </select>

    <!-- 根据用户ID查询菜单 -->
    <select id="selectByUserId" parameterType="long" resultMap="MenuResultMap">
        SELECT DISTINCT m.<include refid="Base_Column_List"/>
        FROM sys_menu m
        INNER JOIN sys_role_permission rp ON m.permission = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId} 
        AND m.deleted = 0 
        AND rp.deleted = 0 
        AND ur.deleted = 0
        ORDER BY m.sort ASC, m.create_time ASC
    </select>

    <!-- 查询菜单总数 -->
    <select id="selectCount" resultType="int">
        SELECT COUNT(*)
        FROM sys_menu
        WHERE deleted = 0
    </select>

    <!-- 根据状态查询菜单数量 -->
    <select id="selectCountByStatus" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM sys_menu
        WHERE status = #{status} AND deleted = 0
    </select>

    <!-- 根据名称和父ID查询菜单（用于检查重复） -->
    <select id="selectByNameAndParentId" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE name = #{name} 
        AND parent_id = #{parentId} 
        AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        LIMIT 1
    </select>

    <!-- 查询菜单树结构 -->
    <select id="selectMenuTree" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE deleted = 0
        ORDER BY sort ASC, create_time ASC
    </select>

    <!-- 根据权限编码查询菜单 -->
    <select id="selectByPermission" parameterType="string" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE permission = #{permission} AND deleted = 0
        LIMIT 1
    </select>

    <!-- 查询可见菜单 -->
    <select id="selectVisibleMenus" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE deleted = 0 AND status = 1 AND visible = 1
        ORDER BY sort ASC, create_time ASC
    </select>

</mapper>
